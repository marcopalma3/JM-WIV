<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Marco Palma">
<meta name="dcterms.date" content="2025-03-15">

<title>Analysis on the UK CF registry</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="CFanalysis_JMWIV_files/libs/clipboard/clipboard.min.js"></script>
<script src="CFanalysis_JMWIV_files/libs/quarto-html/quarto.js"></script>
<script src="CFanalysis_JMWIV_files/libs/quarto-html/popper.min.js"></script>
<script src="CFanalysis_JMWIV_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="CFanalysis_JMWIV_files/libs/quarto-html/anchor.min.js"></script>
<link href="CFanalysis_JMWIV_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="CFanalysis_JMWIV_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="CFanalysis_JMWIV_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="CFanalysis_JMWIV_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="CFanalysis_JMWIV_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<style>

      .quarto-title-block .quarto-title-banner h1,
      .quarto-title-block .quarto-title-banner h2,
      .quarto-title-block .quarto-title-banner h3,
      .quarto-title-block .quarto-title-banner h4,
      .quarto-title-block .quarto-title-banner h5,
      .quarto-title-block .quarto-title-banner h6
      {
        color: #FFDDFF;
      }

      .quarto-title-block .quarto-title-banner {
        color: #FFDDFF;
      }
</style>


</head>

<body>

<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-left">
      <h1 class="title">Analysis on the UK CF registry</h1>
            <p class="subtitle lead">A Bayesian location-scale joint model for time-to-event and multivariate longitudinal data with association based on within-individual variability</p>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta column-page-left">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Marco Palma </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 15, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="page-columns page-rows-contents page-layout-full">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#dataset" id="toc-dataset" class="nav-link" data-scroll-target="#dataset">Dataset</a></li>
  <li><a href="#subset-used-for-the-analysis---inclusion-criteria" id="toc-subset-used-for-the-analysis---inclusion-criteria" class="nav-link" data-scroll-target="#subset-used-for-the-analysis---inclusion-criteria">Subset used for the analysis - inclusion criteria</a></li>
  <li><a href="#cf-female-dataset---administrative-censoring-at-50" id="toc-cf-female-dataset---administrative-censoring-at-50" class="nav-link" data-scroll-target="#cf-female-dataset---administrative-censoring-at-50">CF Female dataset - Administrative censoring at 50</a></li>
  </ul></li>
  <li><a href="#jm-wiv-for-females-cv-association---fit-model" id="toc-jm-wiv-for-females-cv-association---fit-model" class="nav-link" data-scroll-target="#jm-wiv-for-females-cv-association---fit-model">JM-WIV for females (CV association) - Fit model</a></li>
  <li><a href="#jm-wiv-for-females-cv-association---results" id="toc-jm-wiv-for-females-cv-association---results" class="nav-link" data-scroll-target="#jm-wiv-for-females-cv-association---results">JM-WIV for females (CV association) - Results</a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session info</a></li>
  </ul>
</nav>
</div>
<main class="content quarto-banner-title-block column-page-left" id="quarto-document-content">





<p>This is the code for the analysis of the UK Cystic Fibrosis Registry data in the paper “A Bayesian location-scale joint model for time-to-event and multivariate longitudinal data with association based on within-individual variability” by Palma et al.&nbsp;(2025).<!-- , available as a preprint on [arxiv](https://arxiv.org/abs/2407.05806). --></p>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<section id="r-packages" class="level3">
<h3 class="anchored" data-anchor-id="r-packages">R packages</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pacman)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">p_load</span>(rstan, brms)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">p_load</span>(ggplot2, ggpubr, ggridges, ggsurvfit, dplyr, tidyr, pipeR, magrittr, gridExtra)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">p_load</span>(stringr, survival, lubridate, DiagrammeR)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># library(devtools) install_github('marcopalma3/rstanjmwiv')</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstanjmwiv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(), <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">6</span>,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">r =</span> <span class="dv">6</span>, <span class="at">b =</span> <span class="dv">6</span>, <span class="at">l =</span> <span class="dv">6</span>, <span class="at">unit =</span> <span class="st">"pt"</span>), <span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="dv">0</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="at">unit =</span> <span class="st">"pt"</span>), <span class="at">legend.box.margin =</span> <span class="fu">margin</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="at">unit =</span> <span class="st">"pt"</span>)))</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="st">"%ni%"</span> <span class="ot">&lt;-</span> <span class="fu">Negate</span>(<span class="st">"%in%"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>var_long <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"gli_fev"</span>, <span class="st">"bmi"</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>var_long_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"FEV1"</span>, <span class="st">"BMI"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="dataset" class="level2">
<h2 class="anchored" data-anchor-id="dataset">Dataset</h2>
<p>Import the dataset and store it in the <code>cfdata</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>cfdata_clean <span class="ot">&lt;-</span> cfdata <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">s01encounterdate =</span> lubridate<span class="sc">::</span><span class="fu">dmy</span>(s01encounterdate), <span class="at">dmg_dateofdeath =</span> lubridate<span class="sc">::</span><span class="fu">dmy</span>(dmg_dateofdeath),</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">dmg_dateofbirth =</span> lubridate<span class="sc">::</span><span class="fu">dmy</span>(dmg_dateofbirth)) <span class="sc">%&gt;%</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_at</span>(<span class="fu">c</span>(<span class="st">"patient_id"</span>, <span class="st">"sitecode_anon"</span>, <span class="st">"dmg_sex"</span>, <span class="st">"dmg_ethnicity_gli"</span>, <span class="st">"s01isthisanannualreviewencounter"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"s05culturespeciesstaph"</span>, <span class="st">"s05culturespeciespseudoaeruginos"</span>, <span class="st">"s07pancreaticenzymesupplements"</span>),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="sc">~</span><span class="fu">factor</span>(.)))</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(cfdata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The number of rows is 166117 and the number of variables is 1357. The number of unique patient ID is 13899.</p>
</section>
<section id="subset-used-for-the-analysis---inclusion-criteria" class="level2">
<h2 class="anchored" data-anchor-id="subset-used-for-the-analysis---inclusion-criteria">Subset used for the analysis - inclusion criteria</h2>
<p>We have kept only the first visit per year per each patient. To account for all transplants, you need to first compute transplanted indicators, then remove missing values (often, in the year of transplant <code>gli_fev</code> is missing).</p>
<ul>
<li>filter longitudinal observations between the age of 18 and 50;</li>
<li>keep only the first observation in each year (in case they have more than one annual reviews);</li>
<li>compute transplant number (how many transplants they have had while in the dataset) and keep only the longitudinal observations before the first transplant</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>explanatory_before <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"patient_id"</span>, <span class="st">"age"</span>, <span class="st">"dmg_sex"</span>, <span class="st">"dmg_dateofbirth"</span>, <span class="st">"f508_class"</span>, <span class="st">"dmg_ageatdiagnosis"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>dependent <span class="ot">&lt;-</span>  var_long</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>cf2 <span class="ot">&lt;-</span> cfdata_clean <span class="sc">%&gt;&gt;%</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  (<span class="sc">~</span> <span class="fu">c</span>(<span class="fu">nrow</span>(.), <span class="fu">length</span>(<span class="fu">unique</span>(.<span class="sc">$</span>patient_id))) <span class="ot">-&gt;</span> a1) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age <span class="sc">&gt;=</span> <span class="dv">18</span> <span class="sc">&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">50</span>) <span class="sc">%&gt;&gt;%</span>           </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  (<span class="sc">~</span> <span class="fu">c</span>(<span class="fu">nrow</span>(.), <span class="fu">length</span>(<span class="fu">unique</span>(.<span class="sc">$</span>patient_id))) <span class="ot">-&gt;</span> a2) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(patient_id) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">!=</span> <span class="fu">lag</span>(year) <span class="sc">|</span> <span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  (<span class="sc">~</span> <span class="fu">c</span>(<span class="fu">nrow</span>(.), <span class="fu">length</span>(<span class="fu">unique</span>(.<span class="sc">$</span>patient_id))) <span class="ot">-&gt;</span> a3) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(patient_id) <span class="sc">%&gt;%</span> </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Transplanted =</span> <span class="fu">cumsum</span>(s10transplantsincelastannualrevi <span class="sc">==</span> <span class="st">"Y"</span>), </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">EverTx =</span> <span class="fu">as.integer</span>(<span class="fu">max</span>(Transplanted)<span class="sc">&gt;</span><span class="dv">0</span>) <span class="co">#, Age_PreviousEncounter = lag(age)</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Transplanted <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="co">#Age_LastEncBeforeTx = max(Age_PreviousEncounter), </span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">Age_LastEncounter =</span> <span class="fu">max</span>(age),</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">Date_LastEncounter =</span> <span class="fu">max</span>(s01encounterdate)) <span class="sc">%&gt;&gt;%</span>  </span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  (<span class="sc">~</span> <span class="fu">c</span>(<span class="fu">nrow</span>(.), <span class="fu">length</span>(<span class="fu">unique</span>(.<span class="sc">$</span>patient_id))) <span class="ot">-&gt;</span> a4) </span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>cf2_bypatient <span class="ot">&lt;-</span> cf2 <span class="sc">%&gt;%</span> </span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(patient_id, dmg_dateofbirth, dmg_sex, dmg_ageatdiagnosis, f508_class) <span class="sc">%&gt;%</span> </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(<span class="fu">across</span>(<span class="fu">everything</span>())) <span class="sc">%&gt;%</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> <span class="do">##add_count(patient_id, name = "no_records") </span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">"diagnosedafter1yo"</span> <span class="ot">=</span> <span class="fu">factor</span>(<span class="fu">ifelse</span>(dmg_ageatdiagnosis<span class="sc">&gt;</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)),</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>         <span class="st">"f508_homozygous"</span> <span class="ot">=</span> <span class="fu">factor</span>(<span class="fu">ifelse</span>(f508_class <span class="sc">==</span> <span class="st">"Homoz"</span>, <span class="dv">1</span>, <span class="dv">0</span>)),</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>         <span class="st">"yob"</span> <span class="ot">=</span> <span class="fu">year</span>(dmg_dateofbirth))</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>cf2 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(cf2, </span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">select</span>(cf2_bypatient, </span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>                        patient_id, diagnosedafter1yo, f508_homozygous, yob),</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>                 <span class="at">by =</span> <span class="st">"patient_id"</span>)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="co"># cf2 %&gt;%</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="co">#   finalfit::missing_pattern(dependent, explanatory_before, rotate.names = TRUE)</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>explanatory_after <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"patient_id"</span>, <span class="st">"age"</span>, <span class="st">"dmg_sex"</span>, <span class="st">"diagnosedafter1yo"</span>,  <span class="st">"f508_homozygous"</span>, <span class="st">"yob"</span>)</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="co"># cf2 %&gt;%</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a><span class="co">#   finalfit::missing_pattern(dependent, explanatory_after, rotate.names = TRUE)</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>cfLONG <span class="ot">&lt;-</span> cf2 <span class="sc">%&gt;%</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(var_long[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>)  <span class="sc">%&gt;%</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(var_long[<span class="dv">2</span>]) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="sc">!!</span><span class="fu">sym</span>(var_long[<span class="dv">2</span>]) <span class="sc">&lt;</span> <span class="dv">80</span>)  <span class="sc">%&gt;%</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(<span class="fu">all_of</span>(explanatory_after)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>  (<span class="sc">~</span> <span class="fu">c</span>(<span class="fu">nrow</span>(.), <span class="fu">length</span>(<span class="fu">unique</span>(.<span class="sc">$</span>patient_id))) <span class="ot">-&gt;</span> a5) </span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>cfLONG<span class="sc">$</span>patient_id <span class="ot">&lt;-</span> <span class="fu">droplevels</span>(cfLONG<span class="sc">$</span>patient_id)</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>cfLONG <span class="ot">&lt;-</span> <span class="fu">ungroup</span>(cfLONG)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Please note, for some people the date of death is recorded, but not the age at death.</p>
<p>Event time is equal to: * death date - if the person died and never received transplant; * last encounter before (first) transplant - if the person received a transplant * last date recorded on the dataset - if the person was not dead and never received transplant by the last date recorded in the dataset.</p>
<p>Death status is equal to: * 1 - if the person died and never received transplant * 0 - otherwise (censored)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>last_deathdate_recorded <span class="ot">&lt;-</span> <span class="fu">max</span>(cf2<span class="sc">$</span>dmg_dateofdeath, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="do">##please note that last recorded survdata$dmg_dateofdeath is "2022-01-15"</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>cfSURV <span class="ot">&lt;-</span> cf2 <span class="sc">%&gt;%</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(patient_id) <span class="sc">%&gt;%</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>()<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(patient_id, dmg_sex, dmg_dateofbirth, dmg_dateofdeath, dmg_ageatdeath, diagnosedafter1yo, f508_homozygous, yob, EverTx, Date_LastEncounter) <span class="sc">%&gt;%</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">event_time =</span> <span class="fu">case_when</span>(</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(dmg_dateofdeath) <span class="sc">&amp;&amp;</span> EverTx <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> dmg_dateofdeath,  <span class="do">###dead with no transplant</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    EverTx <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> Date_LastEncounter,   <span class="do">###people with a transplant</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> last_deathdate_recorded  <span class="do">###alive people with no transplant</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  ),           </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">death_status =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(dmg_dateofdeath) <span class="sc">&amp;&amp;</span> EverTx <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>), </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">ageatevent =</span> <span class="fu">max</span>(<span class="dv">18</span>, <span class="fu">as.numeric</span>(<span class="fu">interval</span>(dmg_dateofbirth, event_time), <span class="st">"years"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(patient_id <span class="sc">%in%</span> <span class="fu">unique</span>(cfLONG<span class="sc">$</span>patient_id)) <span class="sc">%&gt;%</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="cf-female-dataset---administrative-censoring-at-50" class="level2">
<h2 class="anchored" data-anchor-id="cf-female-dataset---administrative-censoring-at-50">CF Female dataset - Administrative censoring at 50</h2>
<ul>
<li>Introduce censoring at 50 years old if they had not experienced the event by then.</li>
<li>Introduce censoring at age at last annual review before transplant.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>female_subsample <span class="ot">&lt;-</span> cfLONG <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dmg_sex <span class="sc">==</span> <span class="st">"F"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(patient_id) <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>cfLONG_female <span class="ot">&lt;-</span> cfLONG <span class="sc">%&gt;%</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(patient_id <span class="sc">%in%</span> female_subsample) <span class="sc">%&gt;%</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">patient_id =</span> <span class="fu">droplevels</span>(patient_id), </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">id =</span> <span class="fu">as.integer</span>(patient_id),</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">age_minus18 =</span> age <span class="sc">-</span> <span class="dv">18</span>,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">bmi10 =</span> bmi<span class="sc">/</span><span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>cfLONG_female <span class="sc">%&gt;%</span> </span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(patient_id) <span class="sc">%&gt;%</span> </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">no_encounters =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">data =</span> ., <span class="fu">aes</span>(<span class="at">x =</span> no_encounters))  <span class="sc">+</span> </span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">width =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Annual encounters"</span>, <span class="at">y =</span> <span class="st">"Number of individuals"</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>cfLONG_female <span class="sc">%&gt;%</span> </span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(patient_id) <span class="sc">%&gt;%</span> </span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">no_encounters =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(no_encounters) <span class="sc">%&gt;%</span> </span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quantile</span>(., <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>25% 50% 75% 
  5   8  12 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>cfLONG_female <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="at">data =</span> .,</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">aes</span>(<span class="at">x =</span> age_minus18,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">y =</span> <span class="sc">!!</span><span class="fu">sym</span>(var_long[<span class="dv">1</span>]))) <span class="sc">+</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">col=</span>f508_homozygous<span class="sc">:</span>diagnosedafter1yo))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>cfLONG_female <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="at">data =</span> .,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">aes</span>(<span class="at">x =</span> age_minus18,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>                             <span class="at">y =</span> <span class="sc">!!</span><span class="fu">sym</span>(var_long[<span class="dv">2</span>]))) <span class="sc">+</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">col=</span>f508_homozygous<span class="sc">:</span>diagnosedafter1yo))</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>cfSURV_female <span class="ot">&lt;-</span> cfSURV <span class="sc">%&gt;%</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(patient_id <span class="sc">%in%</span> female_subsample) <span class="sc">%&gt;%</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">patient_id =</span> <span class="fu">droplevels</span>(patient_id), </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">id =</span> <span class="fu">as.integer</span>(patient_id),</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>         <span class="at">yob80 =</span> yob <span class="sc">-</span> <span class="dv">1980</span>,</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">AC50_ageatevent_minus18 =</span> <span class="fu">ifelse</span>(ageatevent <span class="sc">&gt;</span> <span class="dv">50</span>, <span class="dv">50</span> <span class="sc">-</span> <span class="dv">18</span>, ageatevent <span class="sc">-</span> <span class="dv">18</span>),</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">AC50_ageatevent_minus18 =</span> <span class="fu">ifelse</span>(AC50_ageatevent_minus18 <span class="sc">&gt;</span> <span class="dv">0</span>, AC50_ageatevent_minus18, <span class="dv">0</span>),</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">AC50_death_status =</span> <span class="fu">ifelse</span>(ageatevent <span class="sc">&gt;</span> <span class="dv">50</span> <span class="sc">&amp;</span> death_status <span class="sc">==</span> <span class="dv">1</span>, </span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>                                    <span class="dv">0</span>,   <span class="do">###if they died after 50, censor them </span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>                                    death_status) </span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>cfSURV_female <span class="sc">%&gt;%</span> </span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">survfit2</span>(<span class="fu">Surv</span>(AC50_ageatevent_minus18, AC50_death_status) <span class="sc">~</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>             diagnosedafter1yo, <span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    ggsurvfit<span class="sc">::</span><span class="fu">ggsurvfit</span>() <span class="sc">+</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_confidence_interval</span>() <span class="sc">+</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_risktable</span>() <span class="sc">+</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">32</span>,<span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"years"</span>, <span class="at">y =</span> <span class="st">"Overall survival probability"</span>)</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>cfSURV_female <span class="sc">%&gt;%</span> </span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">survfit2</span>(<span class="fu">Surv</span>(AC50_ageatevent_minus18, AC50_death_status) <span class="sc">~</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>                 f508_homozygous, <span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    ggsurvfit<span class="sc">::</span><span class="fu">ggsurvfit</span>() <span class="sc">+</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_confidence_interval</span>() <span class="sc">+</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_risktable</span>() <span class="sc">+</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">32</span>,<span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"years"</span>, <span class="at">y =</span> <span class="st">"Overall survival probability"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CFanalysis_JMWIV_files/figure-html/CF_female-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CFanalysis_JMWIV_files/figure-html/CF_female-2.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CFanalysis_JMWIV_files/figure-html/CF_female-3.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CFanalysis_JMWIV_files/figure-html/CF_female-4.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CFanalysis_JMWIV_files/figure-html/CF_female-5.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="jm-wiv-for-females-cv-association---fit-model" class="level1">
<h1>JM-WIV for females (CV association) - Fit model</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>f_fev <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">formula</span>(gli_fev <span class="sc">~</span> age_minus18 <span class="sc">+</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                        diagnosedafter1yo <span class="sc">+</span> f508_homozygous <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id)),</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>              <span class="fu">formula</span>(sigma <span class="sc">~</span> age_minus18 <span class="sc">+</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                        diagnosedafter1yo <span class="sc">+</span> f508_homozygous <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id)))</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>f_bmi <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">formula</span>(bmi <span class="sc">~</span> age_minus18 <span class="sc">+</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>                        diagnosedafter1yo <span class="sc">+</span> f508_homozygous <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id)),</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>              <span class="fu">formula</span>(sigma <span class="sc">~</span> age_minus18 <span class="sc">+</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>                        diagnosedafter1yo <span class="sc">+</span> f508_homozygous <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id)))</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>f_Event <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">Surv</span>(AC50_ageatevent_minus18, AC50_death_status) <span class="sc">~</span> diagnosedafter1yo <span class="sc">+</span> f508_homozygous</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>prior_input <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># y1mu_prior_mean = NULL,</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># y2mu_prior_mean = NULL,</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># y1sigma_prior_mean= NULL,</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># y2sigma_prior_mean= NULL,</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># e_prior_mean = NULL,</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># a_prior_mean = rep(0, 4),</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ymu_prior_mean_for_intercept = NULL,</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ysigma_prior_mean_for_intercept = NULL,</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># e_prior_mean_for_aux = NULL,  </span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># y1mu_prior_scale = 5,</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># y2mu_prior_scale = 5,</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># y1sigma_prior_scale = 5,</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># y2sigma_prior_scale = 5,</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># e_prior_scale = 5,</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># a_prior_scale = rep(2.5, 4),</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ymu_prior_scale_for_intercept = rep(0.5, 2),</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ysigma_prior_scale_for_intercept = rep(0.5, 2),</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">e_prior_scale_for_aux =</span> <span class="fu">rep</span>(<span class="dv">5</span>, <span class="dv">6</span>),   <span class="co">#rev(cumsum(1:6))/2, </span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_prior_scale =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_prior_df =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_prior_regularization =</span> <span class="dv">5</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>standata_jmwiv_CFfemale  <span class="ot">&lt;-</span> <span class="fu">make_standata_jmwiv</span>(<span class="at">formulaLong1 =</span> f_fev,</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">formulaLong2 =</span> f_bmi,</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">dataLong =</span> cfLONG_female,</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">id_var =</span> <span class="st">"id"</span>,</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">time_varLong =</span> <span class="st">"age_minus18"</span>,</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">formulaEvent =</span> f_Event,</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">dataEvent =</span> cfSURV_female,</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">a_K =</span> <span class="dv">4</span>,</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">assoc =</span> <span class="st">"CV"</span>,</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">basehaz =</span> <span class="st">"bs"</span>,</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">basehaz_aux =</span> <span class="fu">list</span>(<span class="at">df =</span> <span class="dv">6</span>,  </span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">knots =</span> <span class="cn">NULL</span>, </span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">degree =</span> <span class="dv">3</span>),</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">qnodes =</span> <span class="dv">15</span>L,</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">prior_list =</span> prior_input)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>stanc_mod <span class="ot">&lt;-</span> <span class="fu">stanc</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"STAN_functions/jm-wiv.stan"</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">stan_model</span>(<span class="at">stanc_ret =</span> stanc_mod, <span class="at">model_name =</span> <span class="st">"jmwiv_simple"</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>CFfemale_jmwiv_CVassoc <span class="ot">&lt;-</span> <span class="fu">sampling</span>(<span class="at">object =</span> mod, <span class="at">data =</span> standata_jmwiv_CFfemale,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">cores =</span> <span class="dv">2</span>, <span class="at">chains =</span> <span class="dv">2</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">refresh =</span> <span class="fl">0.2</span>, <span class="at">seed =</span> <span class="dv">856</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">max_treedepth =</span> <span class="dv">15</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Alternatively, the last two chunks can be run using `rstanjmwiv::jmwiv_stan()`` - but this will not save the standata object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>CFfemale_jmwiv_CVassoc <span class="ot">&lt;-</span> <span class="fu">jmwiv_stan</span>(<span class="at">formulaLong1 =</span> f_fev, <span class="at">formulaLong2 =</span> f_bmi,</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataLong =</span> cfLONG_female, <span class="at">id_var =</span> <span class="st">"id"</span>, <span class="at">time_varLong =</span> <span class="st">"age_minus18"</span>, <span class="at">formulaEvent =</span> f_Event,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataEvent =</span> cfSURV_female, <span class="at">a_K =</span> <span class="dv">4</span>, <span class="at">assoc =</span> <span class="st">"CV"</span>, <span class="at">basehaz =</span> <span class="st">"bs"</span>, <span class="at">basehaz_aux =</span> <span class="fu">list</span>(<span class="at">df =</span> <span class="dv">6</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">knots =</span> <span class="cn">NULL</span>, <span class="at">degree =</span> <span class="dv">3</span>), <span class="at">qnodes =</span> <span class="dv">15</span>L, <span class="at">prior_list =</span> prior_input, <span class="at">cores =</span> <span class="dv">2</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">2</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">seed =</span> <span class="dv">856</span>, <span class="at">init_r =</span> <span class="dv">1</span>, <span class="at">control =</span> <span class="fu">list</span>(<span class="at">max_treedepth =</span> <span class="dv">15</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="jm-wiv-for-females-cv-association---results" class="level1">
<h1>JM-WIV for females (CV association) - Results</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">get_elapsed_time</span>(CFfemale_jmwiv_CVassoc))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        warmup sample
chain:1  69461   4468
chain:2  24775   4430</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(CFfemale_jmwiv_CVassoc, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"y1mu_Intercept"</span>, <span class="st">"y1sigma_Intercept"</span>, <span class="st">"y2mu_Intercept"</span>,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"y2sigma_Intercept"</span>, <span class="st">"y1mu_beta"</span>, <span class="st">"y1sigma_beta"</span>, <span class="st">"y2mu_beta"</span>, <span class="st">"y2sigma_beta"</span>),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: jm-wiv.
2 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=2000.

                   mean se_mean   sd  2.5% 97.5% n_eff Rhat
y1mu_Intercept     2.17    0.00 0.03  2.12  2.22    51 1.02
y1sigma_Intercept -1.33    0.00 0.02 -1.37 -1.29  1025 1.00
y2mu_Intercept    21.18    0.01 0.10 20.98 21.39    76 1.01
y2sigma_Intercept  0.24    0.00 0.02  0.20  0.28   611 1.00
y1mu_beta[1]      -0.04    0.00 0.00 -0.04 -0.04   916 1.00
y1mu_beta[2]       0.33    0.00 0.03  0.27  0.38    49 1.00
y1mu_beta[3]      -0.25    0.00 0.03 -0.30 -0.20    53 1.03
y1sigma_beta[1]   -0.02    0.00 0.00 -0.02 -0.02  1656 1.00
y1sigma_beta[2]    0.00    0.00 0.02 -0.04  0.04   792 1.00
y1sigma_beta[3]    0.04    0.00 0.02  0.00  0.08   849 1.00
y2mu_beta[1]       0.04    0.00 0.00  0.04  0.05  1599 1.00
y2mu_beta[2]       0.90    0.02 0.12  0.67  1.14    62 1.03
y2mu_beta[3]      -0.97    0.01 0.11 -1.20 -0.76    65 1.00
y2sigma_beta[1]    0.00    0.00 0.00  0.00  0.00  1759 1.00
y2sigma_beta[2]    0.01    0.00 0.02 -0.03  0.05   372 1.00
y2sigma_beta[3]   -0.08    0.00 0.02 -0.12 -0.04   375 1.01

Samples were drawn using NUTS(diag_e) at Mon Mar  3 07:59:00 2025.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(CFfemale_jmwiv_CVassoc, <span class="at">pars =</span> <span class="st">"a_beta"</span>, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: jm-wiv.
2 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=2000.

           mean se_mean   sd  2.5% 97.5% n_eff Rhat
a_beta[1] -2.67    0.00 0.11 -2.90 -2.45  1188 1.00
a_beta[2]  3.18    0.01 0.43  2.37  4.05   928 1.00
a_beta[3] -0.09    0.00 0.02 -0.13 -0.04   637 1.01
a_beta[4]  0.18    0.00 0.10 -0.01  0.36   748 1.01

Samples were drawn using NUTS(diag_e) at Mon Mar  3 07:59:00 2025.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(CFfemale_jmwiv_CVassoc, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"e_Intercept"</span>, <span class="st">"e_beta"</span>), <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>,</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: jm-wiv.
2 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=2000.

             mean se_mean   sd  2.5% 97.5% n_eff Rhat
e_Intercept  0.12       0 0.06  0.02  0.23  4224    1
e_beta[1]   -0.34       0 0.08 -0.49 -0.19  3939    1
e_beta[2]    0.06       0 0.07 -0.09  0.20  3318    1

Samples were drawn using NUTS(diag_e) at Mon Mar  3 07:59:00 2025.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(CFfemale_jmwiv_CVassoc, <span class="at">pars =</span> <span class="st">"b_sd"</span>, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: jm-wiv.
2 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=2000.

        mean se_mean   sd 2.5% 97.5% n_eff Rhat
b_sd[1] 0.79       0 0.01 0.77  0.81    84 1.04
b_sd[2] 0.44       0 0.01 0.42  0.45   709 1.01
b_sd[3] 3.32       0 0.05 3.23  3.41   180 1.00
b_sd[4] 0.46       0 0.01 0.44  0.47   955 1.00

Samples were drawn using NUTS(diag_e) at Mon Mar  3 07:59:00 2025.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(CFfemale_jmwiv_CVassoc)<span class="sc">$</span>summary[<span class="fu">c</span>(<span class="st">"a_beta[1]"</span>, <span class="st">"a_beta[2]"</span>, <span class="st">"a_beta[3]"</span>,</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"a_beta[4]"</span>), <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">8</span>)] <span class="sc">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">multiply_by</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">10</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">10</span>, <span class="dv">1</span>, <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">exp</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           mean  2.5% 97.5%
a_beta[1] 0.765 0.748 0.782
a_beta[2] 1.374 1.268 1.499
a_beta[3] 0.915 0.875 0.958
a_beta[4] 1.196 0.987 1.439</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ranef_corr_jmwiv</span>(CFfemale_jmwiv_CVassoc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        [,1]    [,2]    [,3]    [,4]
[1,] 1.00000 0.14736 0.47489 0.00494
[2,] 0.14736 1.00000 0.00198 0.23171
[3,] 0.47489 0.00198 1.00000 0.49378
[4,] 0.00494 0.23171 0.49378 1.00000</code></pre>
</div>
</div>
<p>The posterior predictive checks for the longitudinal submodel are useful to assess the general fit.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>list_of_draws <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">extract</span>(CFfemale_jmwiv_CVassoc)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>ppdata <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">10</span>, <span class="fu">ppcheck</span>(<span class="at">list_of_draws =</span> list_of_draws, <span class="at">data =</span> cfLONG_female,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"age_minus18"</span>, <span class="at">idvar =</span> <span class="st">"id"</span>), <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>y1_rep <span class="ot">&lt;-</span> <span class="fu">sapply</span>(ppdata, <span class="st">"[["</span>, <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t</span>()  <span class="do">###extract y1 from all replicates</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>y2_rep <span class="ot">&lt;-</span> <span class="fu">sapply</span>(ppdata, <span class="st">"[["</span>, <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t</span>()  <span class="do">###extract y2 from all replicates</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ppc_dens_overlay</span>(cfLONG_female<span class="sc">$</span>gli_fev, y1_rep)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ppc_dens_overlay</span>(cfLONG_female<span class="sc">$</span>bmi, y2_rep)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CFanalysis_JMWIV_files/figure-html/CFfemale_jmwiv_ppcheck-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CFanalysis_JMWIV_files/figure-html/CFfemale_jmwiv_ppcheck-2.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
</div>
</div>
<p>The baseline hazard is plotted here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>max_time <span class="ot">&lt;-</span> cfSURV_female<span class="sc">$</span>AC50_ageatevent_minus18 <span class="sc">%&gt;%</span> max</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>bs_basis <span class="ot">&lt;-</span> splines<span class="sc">::</span><span class="fu">bs</span>(<span class="fu">seq</span>(<span class="dv">0</span>, max_time, <span class="at">by =</span> <span class="fl">0.1</span>),</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">df =</span> standata_jmwiv_CFfemale<span class="sc">$</span>basehaz_df,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">knots =</span> <span class="cn">NULL</span>,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>                            <span class="at">degree =</span> <span class="dv">3</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>                            <span class="at">Boundary.knots =</span> <span class="fu">c</span>(<span class="dv">0</span>, max_time),</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">intercept =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>draws_basehaz <span class="ot">&lt;-</span> <span class="fu">tcrossprod</span>(bs_basis, list_of_draws<span class="sc">$</span>e_aux) <span class="sc">%&gt;%</span>  <span class="co"># e_aux are coefficients for LOG baseline hazard </span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add</span>(<span class="fu">summary</span>(CFfemale_jmwiv_CVassoc)<span class="sc">$</span>summary[<span class="st">"e_Intercept"</span>, <span class="st">"mean"</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">exp</span>(.) <span class="sc">%&gt;%</span> <span class="do">###baseline hazard</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">apply</span>(., <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">c</span>(<span class="fu">mean</span>(x),<span class="fu">quantile</span>(x, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.975</span>)))) <span class="sc">%&gt;%</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>()</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(draws_basehaz) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Estimate"</span>, <span class="st">"Q2.5"</span>, <span class="st">"Q97.5"</span>)</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="st">"Time"</span> <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>, max_time, <span class="at">by =</span> <span class="fl">0.1</span>),</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>           draws_basehaz) <span class="sc">%&gt;%</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(.,</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> Estimate)) <span class="sc">+</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>Q2<span class="fl">.5</span>, <span class="at">ymax=</span>Q97<span class="fl">.5</span>), <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">fill =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Baseline hazard"</span>, <span class="at">title =</span> <span class="st">"Joint model with CV association"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CFanalysis_JMWIV_files/figure-html/CFfemale_jmwiv_basehaz-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
</div>
</div>
<p>The function below returns the predictions for two randomly selected women.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pred_plot_jmwiv</span>(<span class="at">stanfit =</span> CFfemale_jmwiv_CVassoc, <span class="at">standata =</span> standata_jmwiv_CFfemale,</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">var_labels =</span> <span class="fu">c</span>(var_long_labels, <span class="st">"Survival probability"</span>), <span class="at">id_selected =</span> <span class="fu">c</span>(<span class="dv">811</span>,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>        <span class="dv">938</span>), <span class="at">plot_jm =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Age"</span>) <span class="sc">+</span> <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">32</span>, <span class="at">by =</span> <span class="dv">5</span>), <span class="at">labels =</span> <span class="dv">18</span> <span class="sc">+</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">32</span>, <span class="at">by =</span> <span class="dv">5</span>)) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">strip.text.x =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CFanalysis_JMWIV_files/figure-html/CFfemale_jmwiv_prediction-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="session-info" class="level1">
<h1>Session info</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.3 (2024-02-29 ucrt)
Platform: x86_64-w64-mingw32/x64 (64-bit)
Running under: Windows Server 2022 x64 (build 20348)

Matrix products: default


locale:
[1] LC_COLLATE=English_United Kingdom.utf8 
[2] LC_CTYPE=English_United Kingdom.utf8   
[3] LC_MONETARY=English_United Kingdom.utf8
[4] LC_NUMERIC=C                           
[5] LC_TIME=English_United Kingdom.utf8    

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] bayesplot_1.11.1      rstanjmwiv_1.0.0.0000 DiagrammeR_1.0.11    
 [4] lubridate_1.9.3       survival_3.5-8        stringr_1.5.1        
 [7] gridExtra_2.3         magrittr_2.0.3        pipeR_0.6.1.3        
[10] tidyr_1.3.1           dplyr_1.1.4           ggsurvfit_1.0.0      
[13] ggridges_0.5.6        ggpubr_0.6.0          ggplot2_3.5.0        
[16] brms_2.20.4           Rcpp_1.0.12           rstan_2.32.5         
[19] StanHeaders_2.32.5    pacman_0.5.1         

loaded via a namespace (and not attached):
  [1] formatR_1.14         inline_0.3.21        sandwich_3.1-0      
  [4] rlang_1.1.5          multcomp_1.4-25      matrixStats_1.5.0   
  [7] compiler_4.3.3       mgcv_1.9-1           loo_2.8.0           
 [10] vctrs_0.6.5          reshape2_1.4.4       pkgconfig_2.0.3     
 [13] fastmap_1.1.1        backports_1.5.0      ellipsis_0.3.2      
 [16] labeling_0.4.3       threejs_0.3.3        promises_1.2.1      
 [19] rmarkdown_2.25       markdown_1.12        nloptr_2.0.3        
 [22] purrr_1.0.2          xfun_0.42            jsonlite_1.8.8      
 [25] later_1.3.2          broom_1.0.5          parallel_4.3.3      
 [28] R6_2.6.1             dygraphs_1.1.1.6     RColorBrewer_1.1-3  
 [31] stringi_1.8.3        mvQuad_1.0-8         boot_1.3-30         
 [34] car_3.1-2            estimability_1.5     knitr_1.45          
 [37] zoo_1.8-12           base64enc_0.1-3      timechange_0.3.0    
 [40] httpuv_1.6.14        Matrix_1.6-5         splines_4.3.3       
 [43] igraph_2.0.2         tidyselect_1.2.1     rstudioapi_0.15.0   
 [46] abind_1.4-8          yaml_2.3.8           codetools_0.2-19    
 [49] miniUI_0.1.1.1       curl_5.2.0           pkgbuild_1.4.6      
 [52] lattice_0.22-5       tibble_3.2.1         plyr_1.8.9          
 [55] shiny_1.8.0          withr_3.0.2          bridgesampling_1.1-2
 [58] posterior_1.6.1      coda_0.19-4.1        evaluate_0.23       
 [61] RcppParallel_5.1.10  xts_0.13.2           pillar_1.10.1       
 [64] carData_3.0-5        tensorA_0.36.2.1     checkmate_2.3.2     
 [67] DT_0.32              stats4_4.3.3         shinyjs_2.1.0       
 [70] distributional_0.5.0 generics_0.1.3       rstantools_2.4.0    
 [73] munsell_0.5.1        scales_1.3.0         minqa_1.2.6         
 [76] gtools_3.9.5         xtable_1.8-4         glue_1.8.0          
 [79] emmeans_1.10.0       tools_4.3.3          shinystan_2.6.0     
 [82] data.table_1.15.2    SparseM_1.81         lme4_1.1-35.1       
 [85] colourpicker_1.3.0   ggsignif_0.6.4       visNetwork_2.1.2    
 [88] mvtnorm_1.2-4        grid_4.3.3           QuickJSR_1.6.0      
 [91] crosstalk_1.2.1      colorspace_2.1-1     patchwork_1.2.0     
 [94] nlme_3.1-164         cli_3.6.4            Brobdingnag_1.2-9   
 [97] V8_4.4.2             gtable_0.3.6         rstatix_0.7.2       
[100] digest_0.6.34        TH.data_1.1-2        farver_2.1.2        
[103] htmlwidgets_1.6.4    htmltools_0.5.7      lifecycle_1.0.4     
[106] statmod_1.5.0        mime_0.12            shinythemes_1.2.0   
[109] MASS_7.3-60.0.1     </code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>